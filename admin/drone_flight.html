<!doctype html>
<html data-ng-app="AdminDroneFlightModule">
<head>
<title>Data Input: Drone Flight</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.css">
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<script src="md5.js"></script>

<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
<style>
* { 
    font-family: Lato, sans-serif;
}

#result, #title {
  font-family: Menlo, Lucida Console, fixed;
  font-size: 10px;
}
</style>
</head>
<body data-ng-controller="AdminDroneFlightCtrl">
<div id="success" style="position:fixed;width:100%;z-index:10;" class="hide alert alert-success" role="alert">
  <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
  <span class="sr-only">Error:</span> Data saved successfully.
</div>

<div id="error" style="position:fixed;width:100%;z-index:10;" class="hide alert alert-danger" role="alert">
  <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
  <span class="sr-only">Error:</span> Data was not saved.
</div>
<div class="container">
  <h2><span ng-bind="title()"></span> <button ng-if="item.id" ng-click="deleteItem(item)" type="button" class="btn-xs btn btn-danger">Delete</button></h2>
  <div class="row">
    <div class="col-md-6">
      <form action class="form-horizontal">
        <div class="form-group">
          <label class="control-label col-sm-4" for="operating_entity">Operating Entity</label>
          <div class="col-sm-8">
            <input ng-model="item.operating_entity" type="text" class="form-control" id="operating_entity" placeholder="Name of the entity conducting the drone operation">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="region">Drone Type</label>
          <div class="col-sm-8">
            <select ng-model="item.drone_type" ng-options="item for item in DRONE_TYPES" class="form-control" id="drone_type">
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="drone_model_name">Drone Model</label>
          <div class="col-sm-8">
            <input ng-model="item.drone_model_name" type="text" class="form-control" id="drone_model_name" placeholder="What model of drone is being used?">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="drone_manufacturer">Drone Manufacturer</label>
          <div class="col-sm-8">
            <input ng-model="item.drone_manufacturer" type="text" class="form-control" id="drone_manufacturer" placeholder="Who manufacturers the drone?">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="region">Cost Range</label>
          <div class="col-sm-8">
            <select ng-model="item.cost_range" ng-options="item for item in COST_RANGES" class="form-control" id="cost_range">
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="camera_equipment">Camera Equipment</label>
          <div class="col-sm-8">
            <input ng-model="item.camera_equipment" type="text" class="form-control" id="camera_equipment">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="country_name">Country</label>
          <div class="col-sm-8">
            <input ng-model="item.country_name" type="text" class="form-control" id="country_name">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="location_descriptive">Location Description</label>
          <div class="col-sm-8">
            <input ng-model="item.location_descriptive" type="text" class="form-control" id="location_descriptive">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="militants_killed">Geolocation</label>
          <div class="col-sm-4">
            Lat: <input ng-model="item.latitude" type="text" class="form-control" id="latitude">
          </div>
          <div class="col-sm-4">
            Lon: <input ng-model="item.longitude" type="text" class="form-control" id="longitude">
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="date_begun">Date Range</label>
          <div class="col-sm-4">
            Start Month: <input ng-model="item.date_begun" type="month" class="form-control" id="date_begun">
          </div>
          <div class="col-sm-4">
            End Month: <input ng-model="item.date_ended" type="month" class="form-control" id="date_ended">
          </div>
        </div>
      </form>
    </div>
    <div class="col-md-6">
      <form action class="form-horizontal">
        <div class="form-group">
          <label class="control-label col-sm-4" for="target_type">Mission Type</label>
          <div class="col-sm-4" ng-repeat="missionList in MISSION_TYPES | cols:2">
            <div class="checkbox" ng-repeat="mission in missionList">
              <label>
                <input type="checkbox" ng-click="toggleMission(item, mission)" ng-checked="item.mission_type.indexOf(mission) > -1" /> {{mission}} 
              </label>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="notes">Mission Description</label>
          <div class="col-sm-8">
            <textarea ng-model="item.mission_description" class="form-control" rows="8" id="mission_description"></textarea>
          </div>
        </div>
        <div class="form-group">
          <label class="control-label col-sm-4" for="sources">Sources</label>
          <div class="col-sm-8">
            <table class="table table-striped table-condensed">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Link</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="src in item.sources">
                  <td class="col-md-4">
                    <a style="position:absolute;cursor:pointer" ng-click="removeSource(item.sources, src)"><span class="glyphicon glyphicon-remove"></span></a>
                    <input class="form-control" ng-model="src.name" type="text">
                  </td>
                  <td><input class="form-control" ng-model="src.url" type="text"></td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td><button type="button" class="btn btn-primary btn-xs" ng-click="addSource(item.sources)">Add Source</button></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-4 text-right">ID</div>
          <div class="col-sm-4"><input type="text" ng-model="item.id" disabled class="form-control" id="id"></div>
          <div class="col-sm-4 text-right">
            <button data-loading-text="Saving..." class="btn btn-block btn-primary" type="button" id="save" ng-click="save(item, $event)">Save Entry</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<script type="text/javascript">
var NAF = {
  "qs": function(k) {
     return (NAF._qs||(NAF._qs=location.search.slice(1).split("&").reduce(function(p,c){c=c.split("=");p[c[0]]=decodeURIComponent(c[1]);return p;},{})))[k];
  }
};

var app = angular.module("AdminDroneFlightModule", []);
app.filter("cols", function() {
  return function(input, cols) {
    var len = input.length / cols;
    return input.reduce(function(p,c,i) {
      (p[Math.floor(i/len)] = p[Math.floor(i/len)] || []).push(c);
      return p;
      }, []);
  };
}).controller("AdminDroneFlightCtrl", ["$scope", "$http", function ($scope, $http) {
  var CKAN_UPSERT = "https://data.opentechinstitute.org/api/3/action/datastore_upsert";
  var CKAN_DELETE = "https://data.opentechinstitute.org/api/3/action/datastore_delete";
  var CKAN_SEARCH = "https://data.opentechinstitute.org/api/3/action/datastore_search";
  var RESOURCE = "cdfe00c8-c34e-4273-b939-c2f08c8d24a2";
  var headers = { 
    // TODO: hard-coded to use my personal API key for now 
    "Authorization": "1eb64664-050b-44f8-a9e1-08bbd93d3ec8", 
    "Content-Type": "application/json" 
  };

  $scope.DRONE_TYPES = [
    "Multirotor",
    "Fixed Wing",
    "Other",
    "N/A"
  ];

  $scope.MISSION_TYPES = [ 
    "Agriculture",
    "Archaeology",
    "Armed Conflict Monitoring",
    "Cargo",
    "Community Mapping",
    "Current Events",
    "Disaster Response",
    "Environmental Surveying",
    "Search and Rescue",
    "Training",
    "Wildlife Surveying",
    "Other"
  ];
  $scope.COST_RANGES = [
    "UNDER $1K",
    "$1K-$5K",
    "$5K-$10K",
    "$10K-$15K",
    "$15K-$20K",
    "$20K-$25K",
    "$25K-$50K",
    "OVER $50K",
    "N/A"
  ];

  $scope.toggleMission = function(item, mission) {
    var idx = item.mission_type.indexOf(mission);
    if(idx > -1) { item.mission_type.splice(idx, 1); }
    else { item.mission_type.push(mission); }
  };
  
  $scope.item = newItem(); 

  $scope.title = function title() { return $scope.item.id ? "Edit " + $scope.item.id : "New Drone Flight"; };

  $scope.addSource = function(list) {
    list.push({});
  };

  $scope.removeSource = function(list, src) {
    var idx = list && list.indexOf(src);
    list.splice(idx, 1);
  };
  
  var saving = false;
  $scope.save = function save(item, $event) {
    if(saving) { return; }
    saving = true;
    $($event.currentTarget).button("loading");

    var body = { 
      "resource_id": RESOURCE, 
      "records": [toRecord(item)]
    };

    $http.post(CKAN_UPSERT, body, { "headers": headers })
    .success(function(data) {
      saving = false;
      $($event.currentTarget).button("reset");
      $("#success").removeClass("hide").show().delay(5000).fadeOut();
    })
    .error(function() {
      saving = false;
      $($event.currentTarget).button("reset");
      $("#error").removeClass("hide").show().delay(5000).fadeOut();
    });
  };

  $scope.deleteItem = function deleteItem(item) {
    var body = { 
      "resource_id": RESOURCE, 
      "filters": { "id": item.id }
    };
    if(confirm("Are you sure you want to delete " + item.id + "?")) {
      $http.post(CKAN_DELETE, body, { "headers": headers })
      .success(function(data) {
        $("#success").removeClass("hide").show().delay(5000).fadeOut();
        $scope.item = newItem();
      })
      .error(function() {
        $("#error").removeClass("hide").show().delay(5000).fadeOut();
      });
    }
  };

  if(NAF.qs("id")) {
    // query for entry
    var params = { "resource_id": RESOURCE, "filters": { "id": NAF.qs("id") } };
    $http.post(CKAN_SEARCH, params).success(function item_handler(data) {
      if(data.result.records.length) {
        toForm(data.result.records[0], $scope);
      }
    });
  }

}]);
function newItem() {
  var yesterday = new Date(new Date().getTime()-86400000);
  return {
    "date_begun": yesterday,
    "date_ended": null,
    "drone_type": "N/A",
    "cost_range": "N/A",
    "sources": [],
    "mission_type": []
  };
};

function toForm(obj, $scope) {
  $scope.item = obj;

  var date_begun = obj.date_begun;
  var date_ended = obj.date_ended;
  if(date_begun < 10000) { date_begun = date_begun*100 + 1; }
  if(date_ended < 10000) { date_ended = date_ended*100 + 1; }
  $scope.item.date_begun = new Date(Math.floor(date_begun/100), date_begun%100 - 1, 1);
  $scope.item.date_ended = new Date(Math.floor(date_ended/100), date_ended%100 - 1, 1);
}

function toRecord(obj) {
  var rec = $.extend({}, obj);

  // clean values
  Object.keys(rec).forEach(function(k) {
    if(rec[k] === "") { rec[k] = null; }
  });

  rec.date_begun = new String(obj.date_begun.getFullYear()*100 + obj.date_begun.getMonth() + 1);
  rec.date_ended = obj.date_ended && !isNaN(obj.date_ended) ? obj.date_ended.getFullYear()*100 + obj.date_ended.getMonth() + 1 : "ONGOING";

  // calculated fields
  rec.geometry = {
    "type": "Point",
    "coordinates": [ rec.longitude, rec.latitude ]
  };

  var under_10k = ["UNDER $1K","$1K-$5K","$5K-$10K"].indexOf(rec.cost_range) > -1;
  rec.over_under_10k = rec.cost_range == "N/A" ? "N/A" : under_10k ? "Under" : "Over";

  rec.id = rec.id || md5(JSON.stringify(rec)).slice(0,7);
  obj.id = rec.id;
  delete rec._id;
  return rec;
}
</script>
</body>
</html>

